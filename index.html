<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compteur de Glucides</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, system-ui, sans-serif; background: #fafafa; color: #222; }
header {
  position: sticky; top: 0; z-index: 10;
  background: #2e7d32; color: #fff;
  padding: 16px 20px; text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
}
header h1 { font-size: 18px; font-weight: 500; margin-bottom: 4px; }
header .total { font-size: 32px; font-weight: 700; }
header .total small { font-size: 16px; font-weight: 400; }
.source-bar {
  display: flex; justify-content: center; align-items: center; gap: 6px;
  padding: 8px 12px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0;
}
.source-bar .pills {
  display: inline-flex; border-radius: 8px; overflow: hidden;
  border: 1px solid #ccc;
}
.source-bar .pills button {
  border: none; padding: 6px 14px; font-size: 13px; cursor: pointer;
  background: #fff; color: #555; font-weight: 500;
}
.source-bar .pills button.active {
  background: #2e7d32; color: #fff;
}
.source-bar .perso-count {
  font-size: 12px; color: #888; margin-left: 4px;
}
main { padding: 12px; max-width: 600px; margin: 0 auto; }
.row {
  background: #fff; border-radius: 12px; padding: 12px;
  margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,.1);
  display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: end;
}
.row.four { grid-template-columns: 1fr; }
.field { display: flex; flex-direction: column; }
.field label { font-size: 11px; color: #666; margin-bottom: 2px; text-transform: uppercase; }
.field input {
  border: 1px solid #ddd; border-radius: 8px; padding: 10px;
  font-size: 16px; width: 100%; background: #fafafa;
}
.field input:focus { outline: none; border-color: #2e7d32; background: #fff; }
.field .result { font-size: 18px; font-weight: 600; color: #2e7d32; padding: 10px 0; }
.row .name-field { grid-column: 1 / -1; position: relative; }
.row .name-field input { font-weight: 500; }
.dropdown {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 20;
  background: #fff; border: 1px solid #ddd; border-radius: 8px;
  margin-top: 2px; max-height: 200px; overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,.15); display: none;
}
.dropdown.open { display: block; }
.dropdown div {
  padding: 10px 12px; font-size: 15px; cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
}
.dropdown div:active, .dropdown div.active { background: #e8f5e9; }
.dropdown div span.pct { color: #888; font-size: 13px; }
.dropdown div .del-perso {
  color: #c62828; font-size: 16px; font-weight: 700; margin-left: 8px;
  padding: 2px 6px; border-radius: 4px; line-height: 1;
}
.dropdown div .del-perso:active { background: #fce4ec; }
.dropdown .dd-save {
  color: #2e7d32; font-weight: 600; font-style: italic;
}
.btn-delete {
  background: none; border: none; color: #c62828; font-size: 24px;
  cursor: pointer; padding: 8px; line-height: 1; border-radius: 8px;
}
.btn-delete:active { background: #fce4ec; }
.btn-add {
  display: block; width: 100%; padding: 14px; margin-top: 4px;
  background: #2e7d32; color: #fff; border: none; border-radius: 12px;
  font-size: 16px; font-weight: 600; cursor: pointer;
}
.btn-add:active { background: #1b5e20; }
.btn-reset {
  display: block; width: 100%; padding: 12px; margin-top: 8px;
  background: none; color: #999; border: 1px solid #ddd; border-radius: 12px;
  font-size: 14px; cursor: pointer;
}
</style>
</head>
<body>

<header>
  <h1>Glucides du repas</h1>
  <div class="total"><span id="total">0</span><small> g</small></div>
</header>

<div class="source-bar">
  <div class="pills">
    <button id="btn-light" onclick="setSource('light')">Light</button>
    <button id="btn-full" onclick="setSource('full')">Complète</button>
  </div>
  <span class="perso-count" id="perso-count"></span>
</div>

<main>
  <div id="rows"></div>
  <button class="btn-add" onclick="addRow()">+ Ajouter une ligne</button>
  <button class="btn-reset" onclick="resetAll()">Nouveau repas</button>
  <p style="margin-top:24px;font-size:11px;color:#aaa;text-align:center;line-height:1.4">Valeurs indicatives pouvant varier selon les produits et préparations. Ne se substitue pas à un avis médical.<br>Données : Anses, Table Ciqual 2025 — Licence Ouverte.</p>
</main>

<script src="aliments-light.js"></script>
<script src="aliments-full.js"></script>
<script>
let rows = JSON.parse(localStorage.getItem('glucides-rows') || '[]');
let source = localStorage.getItem('glucides-source') || 'light';
let perso = JSON.parse(localStorage.getItem('glucides-perso') || '[]');

const container = document.getElementById('rows');
const totalEl = document.getElementById('total');

function getBase() {
  return source === 'full' ? ALIMENTS_FULL : ALIMENTS_LIGHT;
}

function setSource(s) {
  source = s;
  localStorage.setItem('glucides-source', s);
  updateSourceUI();
}

function updateSourceUI() {
  document.getElementById('btn-light').classList.toggle('active', source === 'light');
  document.getElementById('btn-full').classList.toggle('active', source === 'full');
  const pc = document.getElementById('perso-count');
  pc.textContent = perso.length ? '★ ' + perso.length + ' perso' : '';
}

function savePerso() {
  localStorage.setItem('glucides-perso', JSON.stringify(perso));
  updateSourceUI();
}

function save() {
  localStorage.setItem('glucides-rows', JSON.stringify(rows));
}

function update() {
  let t = 0;
  rows.forEach(r => { t += (r.poids * r.pct / 100) || 0; });
  totalEl.textContent = Math.round(t * 10) / 10;
  save();
}

function render() {
  container.innerHTML = '';
  rows.forEach((r, i) => {
    const g = Math.round((r.poids * r.pct / 100 || 0) * 10) / 10;
    const div = document.createElement('div');
    div.className = 'row';
    div.innerHTML = `
      <div class="field name-field">
        <label>Aliment</label>
        <input type="text" value="${esc(r.nom)}" placeholder="ex: Riz" autocomplete="off"
          data-i="${i}" data-f="nom">
        <div class="dropdown" data-i="${i}"></div>
      </div>
      <div class="field">
        <label>Poids (g)</label>
        <input type="number" inputmode="decimal" value="${r.poids || ''}"
          placeholder="0" data-i="${i}" data-f="poids">
      </div>
      <div class="field">
        <label>Glucides %</label>
        <input type="number" inputmode="decimal" value="${r.pct || ''}"
          placeholder="0" data-i="${i}" data-f="pct">
      </div>
      <div class="field" style="text-align:center">
        <label>= g</label>
        <div class="result">${g}</div>
      </div>
      <button class="btn-delete" onclick="delRow(${i})">×</button>
    `;
    container.appendChild(div);
  });
  update();
}

function esc(s) { return (s || '').replace(/"/g, '&quot;'); }

container.addEventListener('focusin', e => {
  const inp = e.target;
  if (inp.dataset.f === 'nom' && inp.value.trim()) showDropdown(inp, +inp.dataset.i);
});

container.addEventListener('input', e => {
  const inp = e.target;
  if (!inp.dataset.f) return;
  const i = +inp.dataset.i, f = inp.dataset.f;
  rows[i][f] = f === 'nom' ? inp.value : parseFloat(inp.value) || 0;
  const row = inp.closest('.row');
  const res = row.querySelector('.result');
  const g = Math.round((rows[i].poids * rows[i].pct / 100 || 0) * 10) / 10;
  res.textContent = g;
  update();
  if (f === 'nom') showDropdown(inp, i);
});

function showDropdown(inp, i) {
  const dd = inp.parentElement.querySelector('.dropdown');
  const q = inp.value.trim().toLowerCase();
  if (q.length === 0) { dd.classList.remove('open'); return; }

  // Search in perso first, then in active base
  const pMatches = perso.filter(a => a.nom.toLowerCase().includes(q));
  const bMatches = getBase().filter(a => a.nom.toLowerCase().includes(q));

  // Merge: perso first (starred), then base, limit total to 8
  const all = [];
  pMatches.forEach(a => all.push({nom: a.nom, pct: a.pct, perso: true}));
  bMatches.forEach(a => {
    if (!all.find(x => x.nom === a.nom)) all.push({nom: a.nom, pct: a.pct, perso: false});
  });
  const matches = all.slice(0, 8);

  // If no matches, offer to save as custom food
  const canSave = matches.length === 0 && q.length > 0;

  if (!matches.length && !canSave) { dd.classList.remove('open'); return; }

  let html = matches.map((a, j) =>
    `<div data-ai="${i}" data-aj="${j}" class="${j===0?'active':''}">` +
    `${a.perso ? '★ ' : ''}${esc(a.nom)}<span class="pct">${a.pct}%</span>` +
    `${a.perso ? '<span class="del-perso" data-delperso="'+esc(a.nom)+'">×</span>' : ''}` +
    `</div>`
  ).join('');

  if (canSave) {
    const pctVal = rows[i].pct;
    const label = pctVal > 0
      ? `★ Sauvegarder « ${esc(inp.value.trim())} » (${pctVal}%)`
      : `★ Sauvegarder « ${esc(inp.value.trim())} » — remplir % d'abord`;
    html += `<div class="dd-save" data-save="${i}">${label}</div>`;
  }

  dd.innerHTML = html;
  dd._matches = matches;
  dd.classList.add('open');
}

container.addEventListener('click', e => {
  // Delete perso
  const delBtn = e.target.closest('[data-delperso]');
  if (delBtn) {
    e.stopPropagation();
    const nom = delBtn.dataset.delperso;
    perso = perso.filter(p => p.nom !== nom);
    savePerso();
    // Refresh dropdown
    const dd = delBtn.closest('.dropdown');
    const i = +dd.dataset.i;
    const inp = dd.parentElement.querySelector('input[data-f="nom"]');
    showDropdown(inp, i);
    return;
  }

  // Save perso
  const saveDiv = e.target.closest('[data-save]');
  if (saveDiv) {
    const i = +saveDiv.dataset.save;
    const nom = rows[i].nom.trim();
    const pct = rows[i].pct;
    const dd = saveDiv.closest('.dropdown');
    dd.classList.remove('open');
    if (!pct || pct <= 0) {
      // Focus the % field so user fills it, then they can re-click name to save
      container.children[i].querySelector('input[data-f="pct"]').focus();
      return;
    }
    if (nom && !perso.find(p => p.nom === nom)) {
      perso.push({nom, pct});
      savePerso();
    }
    return;
  }

  // Select aliment
  const item = e.target.closest('.dropdown div');
  if (!item || item.classList.contains('dd-save')) return;
  const dd = item.closest('.dropdown');
  const i = +dd.dataset.i;
  const j = +item.dataset.aj;
  const a = dd._matches[j];
  selectAliment(i, a);
  dd.classList.remove('open');
});

function selectAliment(i, a) {
  rows[i].nom = a.nom;
  rows[i].pct = a.pct;
  const row = container.children[i];
  row.querySelector('input[data-f="nom"]').value = a.nom;
  row.querySelector('input[data-f="pct"]').value = a.pct;
  const res = row.querySelector('.result');
  const g = Math.round((rows[i].poids * rows[i].pct / 100 || 0) * 10) / 10;
  res.textContent = g;
  update();
  row.querySelector('input[data-f="poids"]').focus();
}

document.addEventListener('click', e => {
  if (!e.target.closest('.name-field')) {
    container.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
  }
});

function addRow() {
  rows.push({ nom: '', poids: 0, pct: 0 });
  render();
  const inputs = container.querySelectorAll('input[data-f="nom"]');
  if (inputs.length) inputs[inputs.length - 1].focus();
}

function delRow(i) {
  rows.splice(i, 1);
  render();
}

function resetAll() {
  rows = [];
  render();
}

updateSourceUI();
if (!rows.length) addRow(); else render();

if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
