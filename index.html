<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compteur de Glucides</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, system-ui, sans-serif; background: #fafafa; color: #222; }
header {
  position: sticky; top: 0; z-index: 10;
  background: #2e7d32; color: #fff;
  padding: 16px 20px; text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
}
header h1 { font-size: 18px; font-weight: 500; margin-bottom: 4px; }
header .total { font-size: 32px; font-weight: 700; }
header .total small { font-size: 16px; font-weight: 400; }
main { padding: 12px; max-width: 600px; margin: 0 auto; }
.row {
  background: #fff; border-radius: 12px; padding: 12px;
  margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,.1);
  display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: end;
}
.row.four { grid-template-columns: 1fr; }
.field { display: flex; flex-direction: column; }
.field label { font-size: 11px; color: #666; margin-bottom: 2px; text-transform: uppercase; }
.field input {
  border: 1px solid #ddd; border-radius: 8px; padding: 10px;
  font-size: 16px; width: 100%; background: #fafafa;
}
.field input:focus { outline: none; border-color: #2e7d32; background: #fff; }
.field .result { font-size: 18px; font-weight: 600; color: #2e7d32; padding: 10px 0; }
.row .name-field { grid-column: 1 / -1; position: relative; }
.row .name-field input { font-weight: 500; }
.dropdown {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 20;
  background: #fff; border: 1px solid #ddd; border-radius: 8px;
  margin-top: 2px; max-height: 200px; overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,.15); display: none;
}
.dropdown.open { display: block; }
.dropdown div {
  padding: 10px 12px; font-size: 15px; cursor: pointer;
  display: flex; justify-content: space-between;
}
.dropdown div:active, .dropdown div.active { background: #e8f5e9; }
.dropdown div span { color: #888; font-size: 13px; }
.btn-delete {
  background: none; border: none; color: #c62828; font-size: 24px;
  cursor: pointer; padding: 8px; line-height: 1; border-radius: 8px;
}
.btn-delete:active { background: #fce4ec; }
.btn-add {
  display: block; width: 100%; padding: 14px; margin-top: 4px;
  background: #2e7d32; color: #fff; border: none; border-radius: 12px;
  font-size: 16px; font-weight: 600; cursor: pointer;
}
.btn-add:active { background: #1b5e20; }
.btn-reset {
  display: block; width: 100%; padding: 12px; margin-top: 8px;
  background: none; color: #999; border: 1px solid #ddd; border-radius: 12px;
  font-size: 14px; cursor: pointer;
}
</style>
</head>
<body>

<header>
  <h1>Glucides du repas</h1>
  <div class="total"><span id="total">0</span><small> g</small></div>
</header>

<main>
  <div id="rows"></div>
  <button class="btn-add" onclick="addRow()">+ Ajouter une ligne</button>
  <button class="btn-reset" onclick="resetAll()">Nouveau repas</button>
</main>

<script>
const ALIMENTS = [
  { nom: "Riz blanc cuit", pct: 28 },
  { nom: "Riz complet cuit", pct: 23 },
  { nom: "Pâtes cuites", pct: 25 },
  { nom: "Pâtes complètes cuites", pct: 23 },
  { nom: "Semoule cuite", pct: 25 },
  { nom: "Quinoa cuit", pct: 21 },
  { nom: "Boulgour cuit", pct: 18 },
  { nom: "Pain blanc", pct: 49 },
  { nom: "Pain complet", pct: 41 },
  { nom: "Pain de mie", pct: 46 },
  { nom: "Baguette", pct: 55 },
  { nom: "Biscottes", pct: 72 },
  { nom: "Croissant", pct: 45 },
  { nom: "Brioche", pct: 48 },
  { nom: "Céréales petit-déj", pct: 75 },
  { nom: "Flocons d'avoine", pct: 58 },
  { nom: "Muesli", pct: 56 },
  { nom: "Pomme de terre cuite", pct: 17 },
  { nom: "Patate douce cuite", pct: 20 },
  { nom: "Frites", pct: 33 },
  { nom: "Purée", pct: 14 },
  { nom: "Lentilles cuites", pct: 17 },
  { nom: "Pois chiches cuits", pct: 18 },
  { nom: "Haricots rouges cuits", pct: 17 },
  { nom: "Haricots blancs cuits", pct: 17 },
  { nom: "Petit pois", pct: 10 },
  { nom: "Maïs", pct: 16 },
  { nom: "Carotte crue", pct: 7 },
  { nom: "Carotte cuite", pct: 5 },
  { nom: "Betterave cuite", pct: 8 },
  { nom: "Tomate", pct: 3 },
  { nom: "Oignon", pct: 8 },
  { nom: "Poivron", pct: 4 },
  { nom: "Courgette", pct: 2 },
  { nom: "Brocoli", pct: 4 },
  { nom: "Chou-fleur", pct: 3 },
  { nom: "Salade verte", pct: 2 },
  { nom: "Pomme", pct: 12 },
  { nom: "Banane", pct: 20 },
  { nom: "Orange", pct: 9 },
  { nom: "Raisin", pct: 16 },
  { nom: "Fraise", pct: 6 },
  { nom: "Mangue", pct: 14 },
  { nom: "Ananas", pct: 11 },
  { nom: "Poire", pct: 10 },
  { nom: "Kiwi", pct: 10 },
  { nom: "Pastèque", pct: 7 },
  { nom: "Melon", pct: 6 },
  { nom: "Compote de pommes", pct: 17 },
  { nom: "Confiture", pct: 60 },
  { nom: "Miel", pct: 80 },
  { nom: "Sucre", pct: 100 },
  { nom: "Chocolat noir 70%", pct: 33 },
  { nom: "Chocolat au lait", pct: 56 },
  { nom: "Nutella", pct: 57 },
  { nom: "Biscuits secs", pct: 70 },
  { nom: "Gâteau", pct: 50 },
  { nom: "Glace", pct: 25 },
  { nom: "Yaourt nature", pct: 5 },
  { nom: "Yaourt aux fruits", pct: 14 },
  { nom: "Lait", pct: 5 },
  { nom: "Fromage blanc", pct: 4 },
  { nom: "Crème dessert", pct: 20 },
  { nom: "Jus d'orange", pct: 10 },
  { nom: "Coca-Cola", pct: 11 },
  { nom: "Bière", pct: 3 },
  { nom: "Pizza Margherita", pct: 28 },
  { nom: "Sushi (riz + poisson)", pct: 20 },
  { nom: "Crêpe nature", pct: 28 },
  { nom: "Galette de sarrasin", pct: 15 },
  { nom: "Couscous (grains cuits)", pct: 23 },
  { nom: "Farine de blé", pct: 73 },
  { nom: "Maïzena", pct: 87 },
];

let rows = JSON.parse(localStorage.getItem('glucides-rows') || '[]');
const container = document.getElementById('rows');
const totalEl = document.getElementById('total');

function save() {
  localStorage.setItem('glucides-rows', JSON.stringify(rows));
}

function update() {
  let t = 0;
  rows.forEach(r => { t += (r.poids * r.pct / 100) || 0; });
  totalEl.textContent = Math.round(t * 10) / 10;
  save();
}

function render() {
  container.innerHTML = '';
  rows.forEach((r, i) => {
    const g = Math.round((r.poids * r.pct / 100 || 0) * 10) / 10;
    const div = document.createElement('div');
    div.className = 'row';
    div.innerHTML = `
      <div class="field name-field">
        <label>Aliment</label>
        <input type="text" value="${esc(r.nom)}" placeholder="ex: Riz" autocomplete="off"
          data-i="${i}" data-f="nom">
        <div class="dropdown" data-i="${i}"></div>
      </div>
      <div class="field">
        <label>Poids (g)</label>
        <input type="number" inputmode="decimal" value="${r.poids || ''}"
          placeholder="0" data-i="${i}" data-f="poids">
      </div>
      <div class="field">
        <label>Glucides %</label>
        <input type="number" inputmode="decimal" value="${r.pct || ''}"
          placeholder="0" data-i="${i}" data-f="pct">
      </div>
      <div class="field" style="text-align:center">
        <label>= g</label>
        <div class="result">${g}</div>
      </div>
      <button class="btn-delete" onclick="delRow(${i})">×</button>
    `;
    container.appendChild(div);
  });
  update();
}

function esc(s) { return (s || '').replace(/"/g, '&quot;'); }

container.addEventListener('input', e => {
  const inp = e.target;
  if (!inp.dataset.f) return;
  const i = +inp.dataset.i, f = inp.dataset.f;
  rows[i][f] = f === 'nom' ? inp.value : parseFloat(inp.value) || 0;
  // update result in same row
  const row = inp.closest('.row');
  const res = row.querySelector('.result');
  const g = Math.round((rows[i].poids * rows[i].pct / 100 || 0) * 10) / 10;
  res.textContent = g;
  update();
  // show dropdown for name field
  if (f === 'nom') showDropdown(inp, i);
});

function showDropdown(inp, i) {
  const dd = inp.parentElement.querySelector('.dropdown');
  const q = inp.value.trim().toLowerCase();
  if (q.length === 0) { dd.classList.remove('open'); return; }
  const matches = ALIMENTS.filter(a => a.nom.toLowerCase().includes(q)).slice(0, 8);
  if (!matches.length) { dd.classList.remove('open'); return; }
  dd.innerHTML = matches.map((a, j) =>
    `<div data-ai="${i}" data-aj="${j}" class="${j===0?'active':''}">` +
    `${esc(a.nom)}<span>${a.pct}%</span></div>`
  ).join('');
  dd._matches = matches;
  dd.classList.add('open');
}

container.addEventListener('click', e => {
  const item = e.target.closest('.dropdown div');
  if (!item) return;
  const dd = item.closest('.dropdown');
  const i = +dd.dataset.i;
  const j = +item.dataset.aj;
  const a = dd._matches[j];
  selectAliment(i, a);
  dd.classList.remove('open');
});

function selectAliment(i, a) {
  rows[i].nom = a.nom;
  rows[i].pct = a.pct;
  const row = container.children[i];
  row.querySelector('input[data-f="nom"]').value = a.nom;
  row.querySelector('input[data-f="pct"]').value = a.pct;
  const res = row.querySelector('.result');
  const g = Math.round((rows[i].poids * rows[i].pct / 100 || 0) * 10) / 10;
  res.textContent = g;
  update();
  // focus weight input
  row.querySelector('input[data-f="poids"]').focus();
}

// close dropdowns on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('.name-field')) {
    container.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
  }
});

function addRow() {
  rows.push({ nom: '', poids: 0, pct: 0 });
  render();
  // focus name input of new row
  const inputs = container.querySelectorAll('input[data-f="nom"]');
  if (inputs.length) inputs[inputs.length - 1].focus();
}

function delRow(i) {
  rows.splice(i, 1);
  render();
}

function resetAll() {
  rows = [];
  render();
}

if (!rows.length) addRow(); else render();

if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
